name: Dependency Updates

on:
  schedule:
    - cron: '0 9 * * 1'  # Monday mornings
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-deps:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - run: npm install

      # Check what's outdated
      - name: Check outdated
        run: |
          npm outdated --json > outdated.json || true
          npm outdated || echo "All up to date"

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: outdated.json
          retention-days: 90

  # Try to apply security fixes
  security-fixes:
    runs-on: ubuntu-latest
    needs: check-deps

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - run: npm install

      # Apply security fixes
      - name: Fix vulnerabilities
        run: npm audit fix || true

      - name: Test after fixes
        run: npm test

      # Check if anything changed
      - name: Check changes
        id: changes
        run: |
          if git diff --quiet package.json package-lock.json; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      # Create PR if we have updates
      - name: Create PR
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'Update dependencies (security fixes)'
          title: 'Security Updates'
          body: |
            Auto-update for security vulnerabilities
            
            - Applied npm audit fix
            - Tests passing
            
            Please review before merging.
          branch: deps-update-${{ github.run_number }}
          delete-branch: true
